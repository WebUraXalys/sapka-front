<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.10.1/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="pages/styles/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="./app.js"></script>
    <script>
        document.addEventListener('alpine:init', () => {
            const socket = new WebSocket('ws://localhost:8000/ai/wschat');
            let tst = document.getElementById("123");
            let active_chat = Alpine.reactive({obj: tst})

            msg = decodeURIComponent((location.pathname+location.search).substr(1).split("?msg=")[1]);
            firstmessage = document.getElementById("firstmessage");
            firstmessage.textContent = msg;
            
            let data = { messages: [msg] }
        
            let reactiveData = Alpine.reactive(data)
            let button_state = Alpine.reactive({disable: true, consult: false})

            socket.onmessage = function(event) {
                const recv = event.data;
                const recv_json = JSON.parse(recv);
                if (recv_json["role"] == "part") {
                    active_chat.obj.textContent = active_chat.obj.textContent + recv_json["text"];
                }
                if (recv_json["role"] == "finished") {
                    reactiveData.messages.push({role: recv_json["role"], text: recv_json["text"]});
                    button_state.disable = false;
                }
                if (recv_json["role"] == "end") {
                    reactiveData.messages.push({role: recv_json["role"], text: recv_json["text"]});
                    button_state.disable = true;
                    button_state.consult = true;
                }
            };


            Alpine.store('wschat', {
                socket: socket,
                messages: reactiveData,
                inputParams: (location.pathname+location.search).substr(1),
                msg: msg,
                active_chat: active_chat,
                button_state: button_state,
            })
            socket.onopen = function (event) {
                socket.send(JSON.stringify({role: 'user', text: msg}));
            }

        })
    </script>
</head>
<body>
<div class="main-block">
    <div class="container" x-data="{messages: $store.wschat.messages.messages}">
        <div class="flex justify-center mb-5">
            <img src="static/images/logo_believe.svg" alt="Logo">
        </div>
        <div x-data="{query: ''}">
            <input type="text" class="grow" placeholder="Search" x-model="query" />
            <button x-bind:disabled="$store.wschat.button_state.disable"
                @click="$store.wschat.button_state.disable = true; $store.wschat.messages.messages.push({role: 'user', text: query}); $store.wschat.socket.send(JSON.stringify({role: 'user', text: query})); query = ''">submit</button>
        </div>
        <div class="chat chat-end">
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full">
                        <img alt="Tailwind CSS chat bubble component"
                            src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                    </div>
                </div>
                <!-- <button @click="$store.wschat.messages.messages.push('adsasdasdasd'); console.log($store.wschat.active_chat)">TESTTTSTTTSDF</button> -->
                <div class="chat-header">
                    Ви
                </div>
                <div class="chat-bubble" id="firstmessage"></div>
            </div>
            <div class="chat chat-start">
                <div class="chat-image avatar">
                    <div class="w-10 rounded-full">
                        <img alt="Tailwind CSS chat bubble component"
                            src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                    </div>
                </div>
                <div class="chat-header">
                    Віра Асистент
                </div>
                <div class="chat-bubble" id="123"></div>
            </div>
            <template x-for="(message, i) in messages">
                <template x-if="i > 1 && i%2==0">
                    <div>
                        <div class="chat chat-end">
                            <div class="chat-image avatar">
                                <div class="w-10 rounded-full">
                                    <img alt="Tailwind CSS chat bubble component"
                                        src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                                </div>
                            </div>
                            <div class="chat-header">Ви</div>
                            <div class="chat-bubble" x-text="message.text" ></div>
                        </div>
                        <div class="chat chat-start">
                            <div class="chat-image avatar">
                                <div class="w-10 rounded-full">
                                    <img alt="Tailwind CSS chat bubble component"
                                        src="https://daisyui.com/images/stock/photo-1534528741775-53994a69daeb.jpg" />
                                </div>
                            </div>
                            <div class="chat-header">Віра Асистент</div>
                            <div class="chat-bubble" x-init="let cbs = document.querySelectorAll('.chat-bubble'); $store.wschat.active_chat.obj = cbs[cbs.length - 1]"></div>
                        </div>
                    </div>
                </template>
            </template>
            <div x-show="$store.wschat.button_state.consult" class="btn customized-button w-52 mt-5">Консультація з психологом</div>

            
        </div>
        
    </div>
</div>
</body>
</html>